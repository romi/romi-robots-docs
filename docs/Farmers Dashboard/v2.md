
# Documentation for Cablebot v2

## Cablebot Hardware

The cablebot uses two Raspberry Pis, one for the base station and one
for the camera.

The PI's should be running the the 64-bit version of Raspberry Pi OS
Lite.

The user "romi" should be configured on both devices. All the software will be installed in the home directory of the romi user, /home/romi. 


## Cablebot Software

The software is part of the romi-rover-build-and-test repository. It
consists of four separate applications that communicate with each
other over websockets:

* rcom-registry: A directory service that keeps track of the addresses of the applications
* romi-camera: The interface to the camera
* romi-cnc: The interface to any CNC device for the motion 
* romi-config: A shared configuration service for the ROMI services 


### Base station

The following steps have to be taken on the Raspberry Pi that runs the base station:

* Get the source code
* Compile the apps
* Install the Python library
* Copy the config file
* Start the apps
* Run the tests

#### Get the source code

To clone the romi-rover-build-and-test repo, do:

```sh
$ cd /home/romi
$ git clone --branch ci_dev --recurse-submodules https://github.com/romi/romi-rover-build-and-test.git
```

#### Compile the apps

To compile the apps: rcom-registry, romi-cnc, and romi-config:

```sh
$ cd romi-rover-build-and-test
$ mkdir build
$ cd build
$ cmake ..
$ make rcom-registry romi-cnc romi-config
```

#### Install the Python library

```sh
$ cd /home/romi/romi-rover-build-and-test/librcom/python
$ pip install --editable .
$ cd /home/romi/romi-rover-build-and-test/python
$ pip install --editable .
```

#### Copy the config file

```sh
$ cp /home/romi/romi-rover-build-and-test/config/cablebot-v2.json /home/romi/config.json 
```

#### Start the apps

Open a terminal and start the RCOM directory service:
```sh
$ /home/romi/romi-rover-build-and-test/build/bin/rcom-registry 
```

You should see something like:
```sh
Registry server running at 172.20.10.3:10101
```

Open a second terminal and start the config server:
```sh
$ /home/romi/romi-rover-build-and-test/build/bin/romi-config --config /home/romi/config.json 
```

Open a third terminal and start the CNC:
```sh
$ /home/romi/romi-rover-build-and-test/build/bin/romi-cnc 
```

You should see a bunch of messages, and also the path of the log file:
```sh
...
Changing log to '/tmp/romi/log.txt'
...
```

#### Run the tests

In the Python directory, you'll find example code that you can use to test the services.

You can test the config interface, run:
```sh
$ cd /home/romi/romi-rover-build-and-test/python
$ python3 config.py
```

You can test the CNC interface as follows:
```sh
$ cd /home/romi/romi-rover-build-and-test/python
$ python3 cnc.py
```


### Camera module

For the camera module, many of the steps are similar as above. In this case, we'll only compile the romi-camera app.

* Get the source code
* Compile the app
* Start the app
* Run the tests

#### Get the source code

To clone the repo, do:

```sh
$ cd /home/romi
$ git clone --branch ci_dev --recurse-submodules https://github.com/romi/romi-rover-build-and-test.git
```

#### Compile romi-camera

To compile romi-camera:

```sh
$ cd romi-rover-build-and-test
$ mkdir build
$ cd build
$ cmake ..
$ make romi-camera
```

#### Start the app

Open a terminal and run:
```sh
$ /home/romi/romi-rover-build-and-test/build/bin/romi-camera --config /home/romi/config.json --directory /home/romi
```

You should see a bunch of messages, and also the path of the log file:
```sh
...
Changing log to '/tmp/romi/log.txt'
...
```

You can always check that log file for more info.

In the terminal that runs rcom-registry, you should see (IP and port numbers will differ):

```sh
INFO: RegistryServer: Received message: {"request": "register", "topic": "camera", "address": "172.20.10.3:55229"}
INFO: RegistryServer: Register topic 'camera' at 172.20.10.3:55229
```

#### Run the tests

On the base station, you can test the camera interface through the Python API:
```sh
$ cd /home/romi/romi-rover-build-and-test/python
$ python3 camera.py
```

It should store 10 images on the disk, named camera-xxxx.jpg.


## Installation on an Intel Linux PC

The software can also be compiled and tested on a regular PC running Linux. 

We'll suppose that the repository will be cloned in the directory HOME_ROMI. Then do the following.

```sh
$ cd $HOME_ROMI
$ cd romi-rover-build-and-test
$ mkdir build
$ cd build
$ cmake ..
$ make rcom-registry romi-config romi-cnc romi-camera
```

Install the Python library:

```sh
$ cd /home/romi/romi-rover-build-and-test/librcom/python
$ pip install --editable .
$ cd /home/romi/romi-rover-build-and-test/python
$ pip install --editable .
```

Edit the config file:

If you don't have an USB camera connected to the PC, you can configure
a "fake" camera. In the config file, change the camera type to
"fake-camera". Don't change anything else:

```
{
    "camera": {
        "type": "fake-camera"
    }
}
```

The camera will serve an image with random noise.

If you don't have a CNC connected to the PC, you can configure a fake
CNC in the config file. Change the "controller-classname" parameter to
"fake-cnc-controller". Keep everything else unchanged.

```
{
    "cnc": {
        "controller-classname": "fake-cnc-controller"
    }
}
```


Start the applications:

```sh
$ $HOME_ROMI/romi-rover-build-and-test/build/bin/rcom-registry &
$ $HOME_ROMI/romi-rover-build-and-test/build/bin/romi-config --config $HOME_ROMI/romi-rover-build-and-test/config/cablebot-v2-dev.json &
$ $HOME_ROMI/romi-rover-build-and-test/build/bin/romi-cnc &
$ $HOME_ROMI/romi-rover-build-and-test/build/bin/romi-camera &
```









